<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Shooter Prototype (WebAssembly)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS to ensure the game container is centered and takes up the viewport */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent scrolling when game is loaded */
            background-color: #0d1117; /* Dark background matching GitHub theme */
        }
        .container {
            min-height: 100vh;
        }
        canvas {
            display: block;
            margin: 0 auto;
            border: 2px solid #00c0c0; /* Cyan border */
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 192, 192, 0.5);
            max-width: 100vw; 
            max-height: 100vh;
        }
    </style>
</head>
<body class="text-white font-sans">
    <div id="loading-screen" class="container flex flex-col justify-center items-center p-4">
        <h1 class="text-4xl font-bold mb-4 text-cyan-400">Space Shooter: Web Version</h1>
        <div class="text-xl mb-6">Powered by Python and Pyodide</div>
        
        <!-- Loading Bar -->
        <div class="w-80 h-4 bg-gray-700 rounded-full overflow-hidden shadow-inner">
            <div id="progress-bar" class="h-full bg-green-500 transition-all duration-300" style="width: 0%;"></div>
        </div>
        <div id="loading-message" class="mt-4 text-gray-400">Initializing environment...</div>
        
        <p class="mt-8 text-sm text-gray-500">Note: This may take a moment as the Python environment loads (~5-10MB).</p>
        <p id="debug-info" class="mt-2 text-xs text-gray-600 hidden">Check the browser console (F12) for detailed logs if the loading stalls.</p>
    </div>

    <div id="game-container" class="hidden">
        <!-- Canvas will be dynamically created by Pyodide -->
    </div>

    <!-- Step 1: Load the Pyodide library -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <!-- Step 2: Run our application logic -->
    <script>
        console.log("Main script tag running.");

        const loadingScreen = document.getElementById('loading-screen');
        const loadingMessage = document.getElementById('loading-message');
        const progressBar = document.getElementById('progress-bar');
        const gameContainer = document.getElementById('game-container');
        const debugInfo = document.getElementById('debug-info');
        
        const GAME_FILE_NAME = "main.py";

        function updateStatus(message, progress) {
            loadingMessage.textContent = message;
            progressBar.style.width = String(progress) + "%";
            if (progress < 90) {
                debugInfo.classList.remove('hidden');
            }
        }
        
        async function initializePyodide() {
            try {
                console.log("Initializing Pyodide (using global method)...");
                updateStatus("Downloading core Python environment...", 10);
                
                const pyodide = await loadPyodide({
                    onProgress: ({ totalBytes, loadedBytes }) => {
                        const progress = Math.min(80, 10 + Math.floor((loadedBytes / totalBytes) * 70)); // Capped at 80
                        updateStatus("Downloading modules... (" + (loadedBytes / 1024 / 1024).toFixed(1) + "MB)", progress);
                    }
                });

                console.log("Pyodide loaded. Installing micropip...");
                updateStatus("Loading package installer (micropip)...", 85);

                // --- THIS IS THE FIX ---
                // We must explicitly load 'micropip' before we can use it.
                await pyodide.loadPackage("micropip");
                // ---------------------

                console.log("Micropip loaded. Installing Pygame-ce...");
                updateStatus("Installing Pygame dependencies (pygame-ce)...", 90);
                
                await pyodide.runPythonAsync(
                    "import micropip\n" +
                    "await micropip.install('pygame-ce')"
                );

                console.log("Pygame installed. Fetching game code: " + GAME_FILE_NAME);
                updateStatus("Fetching your game code...", 95);
                
                // Use a cache-busting query
                const response = await fetch(GAME_FILE_NAME + "?v=5"); 
                
                console.log("Fetch response received. Status: " + response.status);
                if (!response.ok) {
                    throw new Error("ERROR: Failed to fetch main.py. File not found.");
                }
                const pythonCode = await response.text();
                
                console.log("Python code fetched. Writing to virtual file system...");
                pyodide.FS.writeFile(GAME_FILE_NAME, pythonCode, { encoding: "utf8" });

                updateStatus("Running game...", 100);
                
                const moduleName = GAME_FILE_NAME.slice(0, -3); 
                console.log("Importing Python module: " + moduleName);
                
                await pyodide.runPythonAsync("import " + moduleName);

                console.log("Game import successful. Hiding loading screen.");
                loadingScreen.remove();
                gameContainer.classList.remove('hidden');

            } catch (error) {
                console.error("Pyodide or Pygame execution failed:", error);
                
                const errorMessage = error.name === 'PythonError' ? 
                                     "PYTHON CODE CRASHED. Check console (F12) for traceback!" : 
                                     "Loading Failed: " + error.message;
                
                updateStatus(errorMessage, 100);
                loadingMessage.classList.add('text-red-500', 'font-bold');
            }
        }

        // Call the main function to start everything
        initializePyodide();

    </script>
</body>
</html>